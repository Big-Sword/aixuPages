<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>爱 煦 - 我的</title>
<!--
Holiday Template
http://www.templatemo.com/tm-475-holiday
-->
  <link href="css/font-awesome.min.css" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet">  
  <link href="css/flexslider.css" rel="stylesheet">
  <link href="css/templatemo-style.css" rel="stylesheet">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>
  <body class="tm-gray-bg">
  	<!-- Header -->
  	<div class="tm-header">
  		<div class="container">
  			<div class="row">
  				<div class="col-lg-6 col-md-4 col-sm-3 tm-site-name-container">
  					<a href="#" class="tm-site-name">爱 煦</a>	
  				</div>
	  			<div class="col-lg-6 col-md-8 col-sm-9">
	  				<div class="mobile-menu-icon">
		              <i class="fa fa-bars"></i>
		            </div>
	  				<nav class="tm-nav">
						<ul>
							<li><a href="index.html">首页</a></li>
							<li><a href="product.html">产品中心</a></li>
							<li><a href="about.html">关于我们</a></li>
							<li><a href="login.html" class="active">登录</a></li>
						</ul>
					</nav>		
	  			</div>				
  			</div>
  		</div>	  	
  	</div>
	
	<!-- white bg -->
	<section class="tm-white-bg section-padding-bottom" id="more">
		<div class="container">
			<div class="row">
				<div class="tm-section-header section-margin-top">
					<div class="col-lg-4 col-md-3 col-sm-3"><hr></div>
					<div class="col-lg-4 col-md-6 col-sm-6"><h2 class="tm-section-title">欢迎来到爱煦</h2></div>
					<div class="col-lg-4 col-md-3 col-sm-3"><hr></div>	
				</div>				
			</div>
			
			<div class="row">
			<div class="col-xs-10 col-xs-offset-1 col-sm-8 col-sm-offset-2 col-md-4 col-md-offset-4">
				<div class="login-panel panel panel-default">
					<div class="panel-body">
						<fieldset>
							<div class="form-group">
								<input class="form-control" placeholder="用户名" id="username" type="username" autofocus="">
								<span style="color: red;" id="usernameMsg"></span>
							</div>
							<div class="form-group">
								<input class="form-control" placeholder="密码" id="password" type="password" value="">
								<span style="color: red;" id="passwordMsg"></span>
							</div>
							<button class="btn btn-primary" id="login">登录</button>
						</fieldset>
					</div>
				</div>
			</div>

			<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
			data-backdrop="false" data-keyboard="false">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h4 class="modal-title" id="myModalLabel">修改密码</h4>
								<h5> [为了您的账户安全, 初次登录必须修改密码]</h5>
							</div>
							<div class="modal-body">
								<div class="row">
									<div class="col-lg-12">
										<div class="panel panel-default">
											<div class="panel-body">
												<table id="sample_3" class="table table-striped table-bordered" cellspacing="0" width="100%">
													<div style="text-align:center;height:30px;line-height:30px;" class="col-md-3 control-label" for="loginPassword1">请输入新密码</div>
														<div class="col-md-7">
															<input id="loginPassword1" name="loginPassword1" type="password" class="form-control" placeholder="请输入6-20位新密码, 支持数字和字母">
															</div>
														</div>
													</div>
													<div style="text-align:center;height:30px;line-height:30px;" class="col-md-3 control-label" for="loginPassword2">请确认新密码</div>
														<div class="col-md-7">
															<input id="loginPassword2" name="loginPassword2" type="password" class="form-control" placeholder="请再次输入新密码">
															</div>
														</div>
													</div>
												</table>
											</div>
										</div>
									</div>

								</div>

							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-default" onclick="updatePassword()">确定</button>
							</div>
						</div>
					</div>
			</div>
			<!-- /.col-->
		</div>		
		</div>
	</section>
		<footer class="tm-black-bg">
			<div class="container">
				<div class="row">
					<p class="tm-copyright-text">Copyright &copy; 2084 爱煦
					</p>
				</div>
			</div>
		</footer>
	<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>      		<!-- jQuery -->
  	<script type="text/javascript" src="js/bootstrap.min.js"></script>					<!-- bootstrap js -->
  	<script type="text/javascript" src="js/jquery.flexslider-min.js"></script>			<!-- flexslider js -->
  	<script type="text/javascript" src="js/templatemo-script.js"></script>      		<!-- Templatemo Script -->
	<script>
	//var baseUrl = "http://localhost:8080/";
	 var baseUrl = "http://139.196.12.123:8080/";

		$(function() {

			// https://css-tricks.com/snippets/jquery/smooth-scrolling/
		  	$('a[href*=#]:not([href=#])').click(function() {
			    if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
			      var target = $(this.hash);
			      target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
			      if (target.length) {
			        $('html,body').animate({
			          scrollTop: target.offset().top
			        }, 1000);
			        return false;
			      }
			    }
		  	});		  	
		});
		$(window).load(function(){
			// Flexsliders
		  	$('.flexslider.flexslider-banner').flexslider({
			    controlNav: false
		    });
		  	$('.flexslider').flexslider({
		    	animation: "slide",
		    	directionNav: false,
		    	slideshow: false
		  	});

			//临时调试用
		  	// $('#myModal').modal('show');
		});

		var storage = window.localStorage;
			var token = storage.shopperToken;
			// if(token != undefined && token != "null") {
			// 	location.href = "about.html";
			// }

			$("#login").click(function() {
				var username = $("#username").val();
				if(username.length == 0) {
					$("#usernameMsg").html("用户名不能为空");
					return;
				}
				$("#usernameMsg").html("");
				var pwd = $("#password").val();
				if(pwd.length == 0) {
					$("#passwordMsg").html("密码不能为空");
					return;
				}
				$("#passwordMsg").html("");

				$.ajax({
					type: "post",
					url: baseUrl+ "shopper/common/login",
					async: false,
					contentType: "application/json",
					data: JSON.stringify({
						'loginName': username,
						'loginPassword': pwd
					}),
					success: function(data) {
						if(data.code == 200 && data.data.token != null) {
							storage.shopperToken = data.data.token;
							storage.shopperName = data.data.loginName;
							
							if (data.data.isFirstLogin == true) {
								$('#myModal').modal('show');

							} else {
								location.href = "index.html";
							};
						} else {
							alert("用户名或者密码不正确");
						}
					},
					error: function(data) {
						if(data.status == 401) {
							//重新登录
							location.href = "login.html";
						} else {}
					}
				});
			})

			function updatePassword() {
				var loginPassword1 = $("#loginPassword1").val();
				var loginPassword2 = $("#loginPassword2").val();
				var reg = new RegExp("^[A-Za-z0-9]+$");

				if (loginPassword1.length == 0 || loginPassword2.length == 0) {
					alert("新密码或者确认密码不能为空");
					return;
				}else if (!reg.test(loginPassword1) || !reg.test(loginPassword2)){
					alert("密码只能由数字和字母组成");
					return;
				}else if ((loginPassword1.length>20 || loginPassword1.length<6) 
					|| (loginPassword2.length>20 || loginPassword2.length<6) ){
					alert("密码长度必须在 6 - 20 之间");
					return;
				}else if (loginPassword1 != loginPassword2) {
					alert("两次输入的密码不一致, 请检查您的输入");
					return;
				};

				$.ajax({
					contentType: "application/json",
					headers: {
						"x-token": storage.shopperToken,
						"type": 1
					},
					type: "post",
					dataType: "json",
					url: baseUrl + "shopper/updatePassword",
					data: JSON.stringify({
						"loginPassword": loginPassword1
					}),
					success: function(data) {
						if(data.code == 200) {
							alert("修改成功, 请重新登录");
							storage.removeItem("shopperToken");
							storage.removeItem("shopperName");
							location.href = "login.html";
						} else {
							alert(data.msg);
						}
					},
					"error": function(resp) {
						if(resp.status == 500) {
							alert("服务器异常");
						} else {
							//location.href = "about.html";
						}
					}
				});

			}
	</script>
 </body>
 </html>
