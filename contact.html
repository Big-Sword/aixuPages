<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>爱 煦 - 我的订单</title>
<!--
Holiday Template
http://www.templatemo.com/tm-475-holiday
-->
	<link href="css/font-awesome.min.css" rel="stylesheet">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet">  
	<link href="css/flexslider.css" rel="stylesheet">
	<link href="css/templatemo-style.css" rel="stylesheet">

	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
<body>
	<!-- Header -->
	<div class="tm-header">
		<div class="container">
			<div class="row">
				<div class="col-lg-6 col-md-4 col-sm-3 tm-site-name-container">
					<a href="#" class="tm-site-name">爱 煦</a>	
				</div>
				<div class="col-lg-6 col-md-8 col-sm-9">
					<div class="mobile-menu-icon">
						<i class="fa fa-bars"></i>
					</div>
					<nav class="tm-nav">
						<ul>
							<li><a href="index.html">首页</a></li>
							<li><a href="product.html">产品中心</a></li>
							<li><a href="contact.html" class="active">我的订单</a></li>
							<li>
							<a href="#" id="loginhref" ><span class="glyphicon glyphicon-user"></span> <span id="loginName"></span> <span class="caret"></span></a>
							<ul class="dropdown-menu" id="loginlogout">
								<li>
									<a href="#" onclick="logout()"><span class="glyphicon glyphicon-log-out"></span> 登出</a>
								</li>
							</ul>
							</li>
						</ul>
					</nav>		
				</div>				
			</div>
		</div>	  	
	</div>

	<!-- Banner -->
	<section class="tm-banner">
		<!-- Flexslider -->
		<div class="flexslider flexslider-banner">
		  <ul class="slides">
		    <li>
			    <div class="tm-banner-inner">
					<h1 class="tm-banner-title">Your <span class="tm-yellow-text">Special</span> Tour</h1>
					<p class="tm-banner-subtitle">For Upcoming Holidays</p>
					<a href="#more" class="tm-banner-link">Contact Us</a>	
				</div>
				<img src="img/banner-3.jpg" alt="Banner 3" />	
		    </li>		    
		  </ul>
		</div>	
	</section>
			
	<!-- white bg -->
	<section class="section-padding-bottom" id="more">
		<div class="container">
			<div class="row">
				<div class="tm-section-header section-margin-top">
					<div class="col-lg-4 col-md-3 col-sm-3"><hr></div>
					<div class="col-lg-4 col-md-6 col-sm-6"><h2 class="tm-section-title">我的订单</h2></div>
					<div class="col-lg-4 col-md-3 col-sm-3"><hr></div>	
				</div>				
			</div>

			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-body">
							<table id="sample_2" class="table table-striped table-bordered" cellspacing="0" width="100%">
								<thead>
									<tr>
										<th>订单编号</th>
										<th>下单人</th>
										<th>收货人</th>
										<th>联系方式</th>
										<th>地址</th>
										<th>金额</th>
										<th>送货时间</th>
										<th>婚礼时间</th>
										<th>订单状态</th>
										<th>下单时间</th>
										<th>操作</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>

			

				
				<!-- <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1 col-xxs-12">
					
					<button type="button" class="tm-yellow-table-btn" data-toggle="modal" data-target="#myModal">
  						查看
					</button>
				</div> -->


				<!-- Modal -->
				<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  				<div class="modal-dialog">
  				  <div class="modal-content">
   				   <div class="modal-header">
  				      <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
 				       <h4 class="modal-title" id="myModalLabel">Modal title</h4>
				      </div>
				      <div class="modal-body">
 				       	<div class="row">
							<div class="col-lg-12">
							<div class="panel panel-default">
								<div class="panel-body">
									<table id="sample_3" class="table table-striped table-bordered" cellspacing="0" width="100%">
										<thead>
											<tr>
												<th>商品名称</th>
												<th>型号</th>
												<th>色号</th>
												<th>内容</th>
												<th>商品单价</th>
												<th>购买数量</th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
						</div>
					</div>
				      </div>
 				     <div class="modal-footer">
 				      <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
 				     </div>
				    </div>
				  </div>
				</div>
				
			</div>			
		</div>
	</section>
		<footer class="tm-black-bg">
			<div class="container">
				<div class="row">
					<p class="tm-copyright-text">Copyright &copy; 2084 爱煦
					</p>
				</div>
			</div>
		</footer>
	<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>      		<!-- jQuery -->
	<script type="text/javascript" src="js/bootstrap.min.js"></script>					<!-- bootstrap js -->
	<script type="text/javascript" src="js/jquery.flexslider-min.js"></script>			<!-- flexslider js -->

	<script src="js2/jquery.datetimepicker.full.js"></script>
	<script src="js2/jdt.js"></script>
	<script src="js2/dtb.js"></script>
	<script src="js/fnReloadAjax.js"></script>
	<script type="text/javascript" src="js/templatemo-script.js"></script>      		<!-- Templatemo Script -->
	<script>
	var baseUrl = "http://localhost:8080/";
	// var baseUrl = "http://139.196.12.123:8080/";
		var storage = window.localStorage;
		var token = storage.shopperToken;
		var username = storage.shopperName;
      	// DOM is ready
		$(function() {
			// https://css-tricks.com/snippets/jquery/smooth-scrolling/
			$('a[href*=#]:not([href=#])').click(function() {
				if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
					var target = $(this.hash);
					target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
					if (target.length) {
						$('html,body').animate({
							scrollTop: target.offset().top
						}, 1000);
						return false;
					}
				}
			});
		  	// Flexslider
		  	$('.flexslider').flexslider({
		  		controlNav: false,
		  		directionNav: false
		  	});
		  });

			var TableManaged = function() {
					return {
						// main function to initiate the module
						init: function() {
							console.log(1111)
							if(!jQuery().dataTable) {
								return;
							}
							var zsdz = baseUrl + "/order/myorder";
							$('#sample_2')
								.dataTable({
									// set the initial value
									"ordering": false,
									"oLanguage": {
										"sLengthMenu": "每页显示 _MENU_ 条记录",
										"sInfo": "共 _TOTAL_ 条数据",
										"sZeroRecords": "抱歉， 没有找到(只搜公司名称哦)",
										"sInfoEmpty": "没有数据",
										"sInfoFiltered": "(从 _MAX_ 条数据中检索)",
										"sSearch": "搜索公司名称",
										"sInfo": "当前 _START_ 到 _END_ /共_TOTAL_条数据 ",
										"oPaginate": {
											"sPrevious": "前页",
											"sNext": "后页",
										}
									},
									"bStateSave": true,
									// "bProcessing" : true,
									"bServerSide": true,
									"sAjaxSource": zsdz,
									"fnServerData": function(sSource,
										aoData, fnCallback) {
										$.ajax({
											"dataType": 'json',
											"type": "post",
											"url": zsdz,
											contentType: "application/json",
											headers: {
												"x-token": token,
												"type":1
											},
											"data": {
												aoData: JSON
													.stringify(aoData)
											},
											"success": function(resp) {
												fnCallback(resp);
											},
											"error": function(resp) {
												if(resp.status == 500) {
													alert("服务器异常");
												} else {
													location.href = "login.html";
													// logout();
												}
											}
										});
									},
									"aoColumns": [{
										"mData": "order_num"
									}, {
										"mData": "shopper_name"
									}, {
										"mData": "customer"
									}, {
										"mData": "contact"
									}, {
										"mData": "address"
									}, {
										"mData": "order_price"
									}, {
										"mData": "delivery_time"
									}, {
										"mData": "wedding_time"
									}, {
										"mData": null
									},{
										"mData": "order_time"
									}, {
										"mData": null
									}],
									"aoColumnDefs": [{
										'bSortable': true,
										'aTargets': [6],
										"mRender": function(data,
											type, full) {
											return $.myTime.UnixToDate(full.delivery_time / 1000, true, 8);
										}
										},{
										'bSortable': true,
										'aTargets': [7],
										"mRender": function(data,
											type, full) {
											return $.myTime.UnixToDate(full.wedding_time / 1000, true, 8);
										}
										},{
										'bSortable': true,
										'aTargets': [9],
										"mRender": function(data,
											type, full) {
											return $.myTime.UnixToDate(full.order_time / 1000, true, 8);
										}
										},{
										'bSortable': true,
										'aTargets': [8],
										"mRender": function(data,
											type, full) {
											var status = full.status;
											var html;
											if(status == 0) {
												html = "待确认";
											} else if(status == 1) {
												html = "已确认";
											} else if(status == 2) {
												html = "已送货";
											} else if(status == 3) {
												html = "已完成";
											} else if(status == 4) {
												html = "已取消";
											} else {
												html = "未知";
											}
											return html;
										}
										},{
										'bSortable': false,
										'aTargets': [10],
										"mRender": function(data,
											type, full) {
											var status = full.status;
											if (status == 0) {
												return "<div><a href='#' style='cursor:pointer' onclick='showOrderDetail(" + full.id + ",\"" + full.order_num +"\")'>查看</a>&nbsp;&nbsp;&nbsp;<a href='#' style='cursor:pointer' onclick='cancelOrder(" + full.id + ")'>取消订单</a></div>";
											}else{
												return "<div><a href='#' style='cursor:pointer' onclick='showOrderDetail(" + full.id + ",\"" + full.order_num +"\")'>查看</a></div>";
											};
										}
									}]
								});
						}

					};

				}();

				TableManaged.init();

				function cancelOrder(id) {
					if(confirm("确定要取消这个订单么")) {
						$.ajax({
							contentType: "application/json",
							headers: {
								"x-token": token,
								"type":1
							},
	                		type: "post",
	               		 	dataType: "json",
	              		 	url: baseUrl + "order/ordercancel/"+id,
	              		  	success: function(data) {
	              		      if(data.code == 200) {
									alert("取消成功");
									$('#sample_2').dataTable().fnReloadAjax();
								} else {
									alert(data.msg);
								}
	               		 },
	               		 "error": function(resp) {
								if(resp.status == 500) {
									alert("服务器异常");
								} else {
									//location.href = "about.html";
								}
							}
	            		});
					}
				}

				function showOrderDetail(id,order_num) {
					$('#myModal').modal('show');
					$("#myModalLabel").html("订单号:" + order_num); 
					$("#sample_3  tr:not(:first)").html("");

					$.ajax({
						contentType: "application/json",
						headers: {
							"x-token": token,
							"type":1
						},
                		type: "post",
               		 	dataType: "json",
              		 	url: baseUrl + "order/orderdetail/"+id,
              		  	success: function(json) {
              		      var typeData = json.data;
              		      if (json.code == 200) {
	              		      	$.each(typeData, function(i, n) {
	                 		      var tbBody = ""
	                     	   	tbBody += "<tr><td>" + n.name + "</td>" 
	                     	   	+ "<td>" + n.modelType + "</td>"
	                     	   	+ "<td>" + n.colourType + "</td>" 
	                     	   	+ "<td>" + n.content + "</td>" 
	                     	   	+ "<td>" + n.price + "</td>"  
	                     	   	+ "<td>" + n.productCount + "</td></tr>";
	                      	  $("#sample_3").append(tbBody);
	                   		 });
              		      }else {
								// alert(json.msg);
								// $('#myModal').modal('hidden');
						  }
               		 },
               		 "error": function(resp) {
							if(resp.status == 500) {
								alert("服务器异常");
							} else {
								//location.href = "about.html";
							}
						}
            		});
				}

		// Load Flexslider when everything is loaded.
		$(window).load(function() {	  		
			console.log(token)
			console.log(username)
			if(token == undefined || token == "null") {
					// location.href = "login.html";
					$("#loginhref").attr("href", "login.html"); //这里设置链接地址
		  			$("#loginhref").html("登录");  //这里设置显示的内容

		  			$("#loginlogout").hide();
				} else {
					//class="dropdown-toggle" data-toggle="dropdown"
					$("#loginhref").attr("class", "dropdown-toggle"); //这里设置链接
					$("#loginhref").attr("data-toggle", "dropdown"); //这里设置链接
					$("#loginName").html(storage.shopperName);
				}! function($) {
					$(document).on("click", "ul.nav li.parent > a > span.icon", function() {
						$(this).find('em:first').toggleClass("glyphicon-minus");
					});
					$(".sidebar span.icon").find('em:first').addClass("glyphicon-plus");
			}(window.jQuery);

//	For images only
		    $('.flexslider').flexslider({
			    controlNav: false
		    });
	  	});

	  	function logout() {
			storage.removeItem("shopperToken");
			storage.removeItem("shopperName");
			location.href = "index.html";
		}

		(function($) {
					$.extend({
						myTime: {
							/**
							 * 当前时间戳
							 * @return <int>    unix时间戳(秒) 
							 */
							CurTime: function() {
								return Date.parse(new Date()) / 1000;
							},
							/**       
							 * 日期 转换为 Unix时间戳
							 * @param <string> 2014-01-01 20:20:20 日期格式       
							 * @return <int>    unix时间戳(秒)       
							 */
							DateToUnix: function(string) {
								var f = string.split(' ', 2);
								var d = (f[0] ? f[0] : '').split('-', 3);
								var t = (f[1] ? f[1] : '').split(':', 3);
								return(new Date(
									parseInt(d[0], 10) || null,
									(parseInt(d[1], 10) || 1) - 1,
									parseInt(d[2], 10) || null,
									parseInt(t[0], 10) || null,
									parseInt(t[1], 10) || null,
									parseInt(t[2], 10) || null
								)).getTime() / 1000;
							},
							/**       
							 * 时间戳转换日期       
							 * @param <int> unixTime  待时间戳(秒)       
							 * @param <bool> isFull  返回完整时间(Y-m-d 或者 Y-m-d H:i:s)       
							 * @param <int> timeZone  时区       
							 */
							UnixToDate: function(unixTime, isFull, timeZone) {
								if(typeof(timeZone) == 'number') {
									unixTime = parseInt(unixTime) + parseInt(timeZone) * 60 * 60;
								}
								var time = new Date(unixTime * 1000);
								var ymdhis = "";
								ymdhis += time.getUTCFullYear() + "-";
								ymdhis += (time.getUTCMonth() + 1) + "-";
								ymdhis += time.getUTCDate();
								if(isFull === true) {
									ymdhis += " " + time.getUTCHours() + ":";
									ymdhis += time.getUTCMinutes() + ":";
									ymdhis += time.getUTCSeconds();
								}
								return ymdhis;
							}
						}
					});
				})(jQuery);
	</script>
</body>
</html>
