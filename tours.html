<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>爱 煦 - 产品中心</title>
<!--
Holiday Template
http://www.templatemo.com/tm-475-holiday
--><!-- 
  <link href='http://fonts.useso.com/css?family=Open+Sans:400,300,400italic,600,700' rel='stylesheet' type='text/css'> -->
  <link href="css/font-awesome.min.css" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet"> 
  <link href="css/flexslider.css" rel="stylesheet"> 
  <link href="css/templatemo-style.css" rel="stylesheet">
  <link href="css2/jquery.datetimepicker.css" rel="stylesheet">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>
  <body class="tm-gray-bg">
  	<!-- Header -->
  	<div class="tm-header">
  		<div class="container">
  			<div class="row">
  				<div class="col-lg-6 col-md-4 col-sm-3 tm-site-name-container">
  					<a href="#" class="tm-site-name">爱 煦</a>	
  				</div>
	  			<div class="col-lg-6 col-md-8 col-sm-9">
	  				<div class="mobile-menu-icon">
		              <i class="fa fa-bars"></i>
		            </div>
	  				<nav class="tm-nav">
						<ul>
							<li><a href="index.html">首页</a></li>
							<!-- <li><a href="about.html">About</a></li> -->
							<li><a href="tours.html" class="active">产品中心</a></li>
							<li><a href="contact.html">我的订单</a></li>
							<li>
							<a href="#" id="loginhref" ><span class="glyphicon glyphicon-user"></span> <span id="loginName"></span> <span class="caret"></span></a>
							<ul class="dropdown-menu" id="loginlogout">
								<li>
									<a href="#" onclick="logout()"><span class="glyphicon glyphicon-log-out"></span> 登出</a>
								</li>
							</ul>
						    </li>
						</ul>
					</nav>		
	  			</div>				
  			</div>
  		</div>	  	
  	</div>
	
	<!-- Banner -->
	<section class="tm-banner">
		<!-- Flexslider -->
		<div class="flexslider flexslider-banner">
		  <ul class="slides">
		    <li>
			    <div class="tm-banner-inner">
					<h1 class="tm-banner-title">Find <span class="tm-yellow-text">Tour</span> Programs</h1>
					<p class="tm-banner-subtitle">For Your Destinations</p>
					<a href="#more" class="tm-banner-link">Learn More</a>	
				</div>
		      <img src="img/banner-2.jpg" />
		    </li>
		    <li>
			    <div class="tm-banner-inner">
					<h1 class="tm-banner-title">Lorem <span class="tm-yellow-text">Ipsum</span> Dolor</h1>
					<p class="tm-banner-subtitle">Wonderful Destinations</p>
					<a href="#more" class="tm-banner-link">Learn More</a>	
				</div>
		      <img src="img/banner-3.jpg" />
		    </li>
		    <li>
			    <div class="tm-banner-inner">
					<h1 class="tm-banner-title">Proin <span class="tm-yellow-text">Gravida</span> Nibhvell</h1>
					<p class="tm-banner-subtitle">Velit Auctor</p>
					<a href="#more" class="tm-banner-link">Learn More</a>	
				</div>
		      <img src="img/banner-1.jpg" />
		    </li>
		  </ul>
		</div>			
	</section>
	
	
	<!-- white bg -->
	<section class="tm-white-bg section-padding-bottom" id="more">
		<div class="container">
			<div class="row">
				<div class="tm-section-header section-margin-top">
					<div class="col-lg-4 col-md-3 col-sm-3"><hr></div>
					<div class="col-lg-4 col-md-6 col-sm-6"><h2 class="tm-section-title">产品中心</h2></div>
					<div class="col-lg-4 col-md-3 col-sm-3"><hr></div>	
				</div>				
			</div>
			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-default">
						<div class="panel-body">
							<table id="sample_2" class="table table-striped table-bordered" cellspacing="0" width="100%">
								<thead>
									<tr>
										<th>产品名称</th>
										<th>产品图片</th>
										<th>产品内容</th>
										<th>型号</th>
										<th>色号</th>
										<th>单价</th>
										<th>操作</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="tm-section-header section-margin-top">
					<div class="col-lg-4 col-md-3 col-sm-3"><hr></div>
					<div class="col-lg-4 col-md-6 col-sm-6"><h2 class="tm-section-title">购物车</h2></div>
					<div class="col-lg-4 col-md-3 col-sm-3"><hr></div>	
				</div>				
			</div>
			<div class='row'>
			  <div class='col-lg-12'>
				<div class='panel panel-default'>
				         <div class='panel-body'>
					        <table id='sample_3' class='table table-striped table-bordered' cellspacing='0' width="100%">
									<tr>
										<th>产品名称</th>
										<th>操作</th>
									</tr>
							</table>
						</div>
						<div class='panel-body'>
							<table width="100%">
								<tr>
                                  <td>
					           	   <label class="control-label" for="weddingTime">婚礼时间</label>
					           	   <div >
                 	               <input type="text" class="testS form-control" name = "weddingTime" id="weddingTime" onclick="fullDate('weddingTime')">
                 	               </div>
                 	               </td>
                 	            <td>
                 	           	 <label class="control-label" for="deliveryTime">送货时间</label>
					           	 <div class ="">
                 	               <input type="text" class="testS form-control" name = "deliveryTime" id="deliveryTime" onclick="fullDate('deliveryTime')">
                 	             </div>
                 	         </td>
					           	   <label class=" control-label" for="address">地址</label>
					           	   <div >
                 	               <input type="text" class="form-control" name = "address" id="address">
                 	               </div>
                 	          </td>
                         </tr>
                         <tr>
                             <td>  	 
					           	   <label class="control-label" for="contact">联系方式</label>
					           	   <div>
                 	               <input type="text" class="form-control" name = "contact" id="contact">
                 	              </div>
                 	         
                            </td>
                            <td> 
					           	   <label class=" control-label" for="customer">收货人</label>
					           	   <div >
                 	               <input type="text" class="form-control" name = "customer" id="customer">
                 	              </div>
                 	      
                 	          </td>
                 	          <td>
										<div class=" widget-right">
											<button type="button" onclick="createOrder()"  id = "createOrder" class="btn btn-primary btn-md pull-right">下单</button>
										</div>
							
							   </td>

                           
									
					        
						</tr>
					</table>
						 </div>

			   </div>
				    
		     </div>
		   
	       </div>
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  				<div class="modal-dialog" style="width:800px">
  				  <div class="modal-content">
   				   <div class="modal-header">
  				      <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
 				       <h4 class="modal-title" id="myModalLabel">Modal title</h4>
				      </div>
				      <div class="modal-body">
 				       	<div class="row">
							<div class="col-lg-12">
							<div class="panel panel-default">
								<div class="panel-body">
									<table id="sample_4" class="table table-striped table-bordered" cellspacing="0" width="100%">
										<thead>
											<tr>
												<th>订单号</th>
												<th>收货人</th>
												<th>联系方式</th>
												<th>收货地址</th>
												<th>婚礼时间</th>
												<th>送货时间</th>
												<th>购买者</th>
												<th>商品总价</th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-lg-12">
							<div class="panel panel-default">
								<div class="panel-body">
									<table id="sample_5" class="table table-striped table-bordered" cellspacing="0" width="100%">
										<thead>
											<tr>
												<th>商品名称</th>
												<th>型号</th>
												<th>色号</th>
												<th>内容</th>
												<th>商品单价</th>
												<th>购买数量</th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
						</div>

					  </div>
				      </div>
 				     <div class="modal-footer">
 				      <button type="button" class="btn btn-default" data-dismiss="modal" >取消下单</button>
 				      <button type="button" class="btn btn-default" onclick="createConfirmOrder()">确定下单</button>
 				     </div>
				    </div>
				  </div>
				</div>
        
		</div>
		 	    
	</section>
	
	<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>      		<!-- jQuery -->
	<script type="text/javascript" src="js/bootstrap.min.js"></script>					<!-- bootstrap js -->
	<script type="text/javascript" src="js/jquery.flexslider-min.js"></script>			<!-- flexslider js -->

	<script src="js2/jdt.js"></script>
	<script src="js2/dtb.js"></script>
	<script src="js2/jquery.datetimepicker.full.js"></script>
	<script src="js/fnReloadAjax.js"></script>
	<script type="text/javascript" src="js/templatemo-script.js"></script>   
	<script>
		// HTML document is loaded. DOM is ready.
		var baseUrl = "http://localhost:8080/";
		var storage = window.localStorage;
		var token = storage.shopperToken;
		var username = storage.shopperName;
		var orderId;

		$(function() {
		
			// https://css-tricks.com/snippets/jquery/smooth-scrolling/
		  	$('a[href*=#]:not([href=#])').click(function() {
			    if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
			      var target = $(this.hash);
			      target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
			      if (target.length) {
			        $('html,body').animate({
			          scrollTop: target.offset().top
			        }, 1000);
			        return false;
			      }
			    }
		  	});	
		  	 
		});
        function minProduct(id) {
        	       var input = $("#"+id).next();
        	       var tempValue = parseInt($(input).val());
        	       if(isNaN(tempValue)) {
                     alert("数量输入框只能输入数字");
        	       }else {
               	   var value = tempValue-1;
                   if(value == 0) {
                   	 $("#"+id).parent().parent().parent().remove();
                   }else {
                   	 $(input).val(value);
                   }}
        }

        function increaseProduct(id) {
        	      var input = $("#"+id).prev(); 
        	      var tempValue = parseInt($(input).val());
        	       if(isNaN(tempValue)) {
                     alert("数量输入框只能输入数字");
        	       }else {
               	      var value = tempValue+1;
               	      $(input).val(value);
               	   }

        }

		function addProduct(id,name){
               	      var doc = $("#sample_3").find("#"+id);
               	      var minId = "min"+id;
               	      var increaseId = "increase"+id;
               	      if(doc.length == 0) {
               	          var newRow = "<tr id='"+id+"''><td>"+name+"</td><td><div align='center'><button id='"+minId+"' type='button' onclick='minProduct(\""+minId+"\")' class=' btn btn-default'>-</button> <input style='text-align:right' class='sy_num' size = '5' type='text' value='1' />&nbsp;<button type='button' id='"+increaseId+"' onclick='increaseProduct(\""+increaseId+"\")' class='btn btn-default'>+</button></div></td></tr>";
               	           $("#sample_3 tr:last").after(newRow);
               	      }

		 }
		 function logout() {
			storage.removeItem("shopperToken");
			storage.removeItem("shopperName");
			location.href = "index.html";
		}
		 function DateToUnix(string) {
		 	var f = string.split(' ', 2);
								var d = (f[0] ? f[0] : '').split('/', 3);
								var t = (f[1] ? f[1] : '').split(':', 3);
								return(new Date(
									parseInt(d[0], 10) || null,
									(parseInt(d[1], 10) || 1) - 1,
									parseInt(d[2], 10) || null,
									parseInt(t[0], 10) || null,
									parseInt(t[1], 10) || null,
									parseInt(t[2], 10) || null
								)).getTime();
		 }
		 function UnixToDate (unixTime, isFull, timeZone) {
								if(typeof(timeZone) == 'number') {
									unixTime = parseInt(unixTime) + parseInt(timeZone) * 60 * 60;
								}
								var time = new Date(unixTime * 1000);
								var ymdhis = "";
								ymdhis += time.getUTCFullYear() + "-";
								ymdhis += (time.getUTCMonth() + 1) + "-";
								ymdhis += time.getUTCDate();
								if(isFull === true) {
									ymdhis += " " + time.getUTCHours() + ":";
									ymdhis += time.getUTCMinutes() + ":";
									ymdhis += time.getUTCSeconds();
								}
								return ymdhis;
		 }
		 function createConfirmOrder() {
		 	      $.ajax({
							contentType: "application/json",
							headers: {
								"x-token": token,
								"type":1
							},
	                		type: "post",
	               		 	dataType: "json",
	              		 	url: baseUrl + "order/ordercheck/"+orderId,
	              		  	success: function(data) {
	              		      if(data.code == 200) {
									alert("下单成功");
									$('#myModal').modal('hide');
									$("#sample_4  tr:not(:first)").html("");
					                $("#sample_5  tr:not(:first)").html("");
					                $("#sample_3  tr[id]").remove();
					                $("#weddingTime").val("");
                         	        $("#deliveryTime").val("");
                         	        $("#customer").val("");
                         	        $("#contact").val("");
                         	        $("#address").val("");

								} else {
									alert(data.msg);
								}
	               		 },
	               		 "error": function(resp) {
								if(resp.status == 500) {
									alert("服务器异常");
								} else {
									//location.href = "about.html";
								}
							}
	            		});
					
		 }
		 function createOrder(){
                     var size = $("#sample_3").find("tr").length;
                     if(size <=1) {
                     	alert("您还没有购买商品");
                     	return;
                     }else {
					     $("#createOrder").attr("disabled", true);
					     var list = [];//数组
                         for(var i = 1;i<size;i++) {
                         	var productId = $("#sample_3 tr:eq('"+i+"')").attr("id");
                         	var productNum = $("#sample_3 tr:eq('"+i+"')").find(".sy_num").val();
                         	var weddingTime = DateToUnix($("#weddingTime").val());
                         	var deliveryTime = DateToUnix($("#deliveryTime").val());

                         	var customer = $("#customer").val();
                         	var contact = $("#contact").val();
                         	var address = $("#address").val();

                         	if(isNaN(productNum)) {
                         		alert("数量输入框只能是数字");
                                $("#createOrder").attr("disabled", false);
                         		return;
                         	}
                         	if(weddingTime == undefined || weddingTime =="") {
                         		alert("婚礼时间不能为空");
                         		$("#createOrder").attr("disabled", false);
                         		$("#weddingTime").focus();

                         		return;
                         	}
                         	if(deliveryTime == undefined || deliveryTime =="") {
                         		alert("婚礼时间不能为空");
                         		$("#createOrder").attr("disabled", false);
                         		$("#deliveryTime").focus();
                         		return;
                         	}
                         	if(customer== undefined || customer =="") {
                         		alert("收货人不能为空格");
                         		$("#createOrder").attr("disabled", false);
                         		$("#customer").focus();
                         	}
                         	if(contact == undefined || contact =="") {
                         		alert("联系方式不能为空");
                         		$("#createOrder").attr("disabled", false);
                         		$("#contact").focus();
                         	}
                         	if(address == undefined || address == "") {
                         		alert("地址不能为空");
                         		$("#createOrder").attr("disabled", false);
                         		$("#address").focus();

                         	}
                         	
                                list[i-1] = {"productId":parseInt(productId),"productNum":parseInt(productNum)};
                         	
                         }
              

					    $.ajax({
						
							type: "post",
							url: baseUrl+"order/ordering",
							async: false,
							contentType: "application/json",
							headers: {
								"x-token": token,
								"type":1
							},
							data: JSON.stringify({"orderDetailItems":list,
								"weddingTime":weddingTime,
								"deliveryTime":deliveryTime,
								"customer":customer,
								"contact":contact,
								"address":address
							}),
							success: function(data) {
								if(data.code == 200) {
									var order = data.data.orders;
									orderId = order.id;
									$("#createOrder").attr("disabled", false);
									$('#myModal').modal('show').css({"width":"auto"});
					                $("#myModalLabel").html("订单号:" + order.orderNum);
					                $("#sample_4  tr:not(:first)").html("");
					                $("#sample_5  tr:not(:first)").html("");

	                              

	                                 var newRow = "<tr><td>"+order.orderNum+"</td>"
	                                 +"<td>"+order.customer+"</td>"
	                                 +"<td>"+order.contact+"</td>"
	                                   +"<td>"+order.address+"</td>"
	                                  +"<td>"+UnixToDate(order.weddingTime/1000,true,8)+"</td>"
	                                  +"<td>"+UnixToDate(order.deliveryTime/1000,true,8)+"</td>"
	                                  +"<td>"+order.shopperName+"</td>"
	                                  +"<td>"+order.orderPrice+"</td></tr>";
	                                 $("#sample_4").append(newRow);

						            $.each(data.data.orderDetails, function(i, n) {
		                 		    var tbBody = ""
		                     	   	tbBody += "<tr><td>" + n.name + "</td>" 
		                     	   	+ "<td>" + n.modelType + "</td>"
		                     	   	+ "<td>" + n.colourType + "</td>" 
		                     	   	+ "<td>" + n.content + "</td>" 
		                     	   	+ "<td>" + n.price + "</td>"  
		                     	   	+ "<td>" + n.productCount + "</td></tr>";
		                      	    $("#sample_5").append(tbBody);
		                   		    });
									
								} else {
									alert(data.msg);
								}
							},
							error: function(resp) {
								if(resp.status == 500) {
									alert("服务器异常");
								} else {
									// location.href = "about.html";
								}
							}
						});
						$("#createOrder").attr("disabled", false);
					 }
                
		 }

		
		// Load Flexslider when everything is loaded.
		$(window).load(function() {	  		
		    $('.flexslider').flexslider({
			    controlNav: false
		    });
            console.log(token)
			console.log(username)
			if(token == undefined || token == "null") {
					// location.href = "login.html";
					$("#loginhref").attr("href", "about.html"); //这里设置链接地址
		  			$("#loginhref").html("登录");  //这里设置显示的内容

		  			$("#loginlogout").hide();
				} else {
					//class="dropdown-toggle" data-toggle="dropdown"
					$("#loginhref").attr("class", "dropdown-toggle"); //这里设置链接
					$("#loginhref").attr("data-toggle", "dropdown"); //这里设置链接
					$("#loginName").html(storage.shopperName);
				}! function($) {
					$(document).on("click", "ul.nav li.parent > a > span.icon", function() {
						$(this).find('em:first').toggleClass("glyphicon-minus");
					});
					$(".sidebar span.icon").find('em:first').addClass("glyphicon-plus");
			}(window.jQuery);

            var TableManaged = function() {
					return {
						// main function to initiate the moduleda
						init: function() {
							console.log(1111)
							if(!jQuery().dataTable) {
								return;
							}

							$('#sample_2')
								.dataTable({
									// set the initial value
									"ordering": false,
									"oLanguage": {
										"sLengthMenu": "每页显示 _MENU_ 条记录",
										"sInfo": "共 _TOTAL_ 条数据",
										"sZeroRecords": "抱歉， 没有找到(只搜商品名称哦)",
										"sInfoEmpty": "没有数据",
										"sInfoFiltered": "(从 _MAX_ 条数据中检索)",
										"sSearch": "搜索商品名称",
										"sInfo": "当前 _START_ 到 _END_ /共_TOTAL_条数据 ",
										"oPaginate": {
											"sPrevious": "前页",
											"sNext": "后页",
										}
									},
									"bStateSave": true,
									// "bProcessing" : true,
									"bServerSide": true,
									"sAjaxSource": baseUrl+"product/all",
									"fnServerData": function(sSource,
										aoData, fnCallback) {
										$.ajax({
											"dataType": 'json',
											"type": "post",
											"url": baseUrl+"product/all",
											contentType: "application/json",
											headers: {
												"x-token": token,
												"type":1
											},
											"data": {
												aoData: JSON
													.stringify(aoData)
											},
											"success": function(resp) {
												fnCallback(resp);
											},
											"error": function(resp) {
												if(resp.status == 500) {
													alert("服务器异常");
												} else {
													 // location.href = "about.html";
												}
											}
										});
									},
									"aoColumns": [{
										"mData": "name"
									}, {
										"mData": null,
									}, {
										"mData": "content"
									}, {
										"mData": "model_type"
									}, {
										"mData": "colour_type"
									}, {
										"mData": "price"
									}, {
										"mData": null
									}],
									"aoColumnDefs": [{
										'bSortable': false,
										'aTargets': [6],
										"mRender": function(data,
											type, full) {

											return "<button class='btn btn-primary' onclick='addProduct("+full.id+",\""+full.name+"\")'>加入购物车</button>";
										}
									}, {
										'bSortable': false,
										'aTargets': [1],
										"mRender": function(data,
											type, full) {
											var picUrls = full.pic_url.split("~");
											var html = "";
											for(var i = 0; i < picUrls.length; i++) {
												html += "<a href=\"productImg/" + picUrls[i] + "\" target=\"_blank\"><img src=\"productImg/" + picUrls[i] + "\"  width='40' height='40'/></a>&nbsp;&nbsp;";
												// html += "<a href=\"/Users/longie/custom-lr.png" + "custom-lr.png" + "\" target=\"_blank\"><img src=\"/Users/longie/" + "custom-lr.png" + "\"  width='40' height='40'/></a>&nbsp;&nbsp;";
											}
											return "<div>" + html + "</div>";
										}
									}]
								
							});
						}

					};

				}();

				TableManaged.init();

				

              
	  	}); 

            var logic = function(currentDateTime) {
					if(currentDateTime && currentDateTime.getDay() == 6) {
						this.setOptions({
							minTime: '11:00'
						});
					} else
						this.setOptions({
							minTime: '8:00'
						});
				}
            $.datetimepicker.setLocale('ch'); //设置中文
			function fullDate(id) {}
				$('.testS').datetimepicker({
					onChangeDateTime: logic,
					onShow: logic
				});
				
              
	</script>
 </body>
 </html>
